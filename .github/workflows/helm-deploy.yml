# name: Deploy Redis Helm Chart to EKS

# on:
#   push:
#     branches:
#       - main
#     paths:
#       - 'redis-helm-chart/**'
#   pull_request:
#     branches:
#       - master
#     paths:
#       - redis-helm-chart/**'

# jobs:
#   helm-deploy:
#     name: Deploy Helm Chart
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Set up AWS credentials
#       uses: aws-actions/configure-aws-credentials@v2
#       with:
#         aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
#         aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
#         region: ap-south-1  # Modify if needed

#     - name: Configure kubectl to use EKS cluster
#       run: |
#         aws eks update-kubeconfig --name ${{ secrets.EKS_CLUSTER_NAME }} --region ${{ secrets.AWS_DEFAULT_REGION }} 

#     - name: Install Helm
#       uses: azure/setup-helm@v3
#       with:
#         version: v3.12.0  # Specify your Helm version

#     - name: Install yq for parsing YAML
#       run: |
#         sudo wget https://github.com/mikefarah/yq/releases/download/v4.16.2/yq_linux_amd64 -O /usr/bin/yq
#         sudo chmod +x /usr/bin/yq

#     - name: Get Chart Name and Version
#       id: get_chart_info
#       run: |
#         CHART_NAME=$(yq eval '.name' ./redis-helm-chart/Chart.yaml)
#         CHART_VERSION=$(yq eval '.version' ./redis-helm-chart/Chart.yaml)
#         echo "chart_name=${CHART_NAME}" >> $GITHUB_ENV
#         echo "chart_version=${CHART_VERSION}" >> $GITHUB_ENV

#     - name: Deploy Redis Helm Chart
#       run: |
#         RELEASE_NAME="${{ env.chart_name }}-${{ env.chart_version }}"
#         helm upgrade --install $RELEASE_NAME ./redis-helm-chart \
#           --namespace redis \
#           --create-namespace \
#           --values ./redis-helm-chart/values.yaml





name: Deploy Helm Chart to EKS

on:
  workflow_dispatch:
  push:
    paths:
      - 'redis-helm-chart/**'

# on:
#   push:
#     branches:
#       - master
#     paths:
#       - 'redis-helm-chart/**'
#   pull_request:
#     branches:
#       - master
#     paths:
#       - redis-helm-chart/**'

jobs:
  deploy_helm_chart:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up kubectl
      uses: azure/setup-kubectl@v2
      with:
        version: '1.24.0'  # Specify your required kubectl version

    - name: Configure kubectl
      run: |
        aws eks update-kubeconfig --region ${{ secrets.AWS_REGION }} --name ${{ secrets.EKS_CLUSTER_NAME }}

    - name: Set up Helm
      uses: azure/setup-helm@v1

    - name: Install yq
      run: |
        sudo apt-get install -y yq

        - name: Get Chart Name and Version
        id: get_chart_info
        run: |
          CHART_NAME=$(yq eval '.name' ./redis-helm-chart/Chart.yaml)
          CHART_VERSION=$(yq eval '.version' ./redis-helm-chart/Chart.yaml)
          echo "chart_name=${CHART_NAME}" >> $GITHUB_ENV
          echo "chart_version=${CHART_VERSION}" >> $GITHUB_ENV
  
    - name: Deploy Redis Helm Chart
      run: |
        RELEASE_NAME="${{ env.chart_name }}-${{ env.chart_version }}"
        helm upgrade --install $RELEASE_NAME ./redis-helm-chart \
          --namespace redis \
          --create-namespace \
          --values ./redis-helm-chart/values.yaml
  

    # - name: Get Helm chart name and version
    #   id: helm_chart_info
    #   run: |
    #     chart_name=$(yq eval '.name' redis-helm-chart/values.yaml)
    #     chart_version=$(yq eval '.version' redis-helm-chart/values.yaml)
    #     release_name="${chart_name}-${chart_version}"
    #     echo "chart_name=${chart_name}" >> $GITHUB_ENV
    #     echo "chart_version=${chart_version}" >> $GITHUB_ENV
    #     echo "release_name=${release_name}" >> $GITHUB_ENV

    # - name: Deploy Helm chart to EKS
    #   run: |
    #     helm upgrade --install ${{ env.release_name }} ./redis-helm-chart \
    #       --set image.repository=${{ secrets.ECR_URI }}/${{ secrets.ECR_REPOSITORY }} \
    #       --set image.tag=${{ github.sha }} \
    #       --version ${{ env.chart_version }}




# name: Deploy Helm Chart

# on:
#   workflow_dispatch:

# jobs:
#   deploy_helm_chart:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout code
#       uses: actions/checkout@v3

#     - name: Set up kubectl
#       uses: azure/setup-kubectl@v2
#       with:
#         version: '1.24.0'  # Specify your required kubectl version

#     - name: Configure kubectl
#       run: |
#         aws eks update-kubeconfig --region ${{ secrets.AWS_REGION }} --name ${{ secrets.EKS_CLUSTER_NAME }}

#     - name: Set up Helm
#       uses: azure/setup-helm@v1

#     - name: Install yq
#       run: |
#         sudo apt-get install -y yq

#     - name: Get Helm chart name and version
#       id: helm_chart_info
#       run: |
#         chart_name=$(yq eval '.name' helm-chart/values.yaml)
#         chart_version=$(yq eval '.version' helm-chart/values.yaml)
#         echo "chart_name=${chart_name}" >> $GITHUB_ENV
#         echo "chart_version=${chart_version}" >> $GITHUB_ENV

#     - name: Deploy Helm chart to EKS
#       run: |
#         helm upgrade --install ${{ env.chart_name }} ./helm-chart \
#           --set image.repository=${{ secrets.ECR_URI }}/${{ secrets.ECR_REPOSITORY }} \
#           --set image.tag=${{ github.sha }} \
#           --version ${{ env.chart_version }}
